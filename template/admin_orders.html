<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>NAV Admin - Orders</title>
  <link href="../assets/vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
  <link href="../assets/css/style.css" rel="stylesheet">
</head>
<body>
  <!-- Top header: logo + sign out -->
  <header class="header-main">
    <div class="container-fluid">
      <div class="row">
        <div class="col-6 d-flex align-items-center">
          <a class="logo d-inline-block" href="/">
            <img alt="NAV Productions" src="https://storage.googleapis.com/msgsndr/kst2bkxitM1nA0d1KJd4/media/6901a25fff3e44e0bbf9c102.jpeg" style="height:36px;object-fit:contain;">
          </a>
        </div>
        <div class="col-6 text-end">
          <button id="signoutAdmin" class="btn btn-outline-secondary btn-sm">Sign Out</button>
        </div>
      </div>
    </div>
  </header>

  <main class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="mb-0">Orders</h3>
    </div>
    <div class="mb-3 row">
      <div class="col-sm-6"><input id="q" class="form-control" placeholder="search by id or description"/></div>
      <div class="col-sm-2"><button id="searchBtn" class="btn btn-primary">Search</button></div>
    </div>
    <div id="orders"></div>
    <nav><ul id="pager" class="pagination"></ul></nav>
  </main>

  <script>
    // sign out handler
    document.getElementById('signoutAdmin').addEventListener('click', async function(){
      try {
        await fetch('/api/auth/logout', { method: 'POST', credentials: 'same-origin' });
      } catch(e){}
      localStorage.removeItem('nav_token');
      window.location.href = '/sign_in.html';
    });

    let page = 1, limit = 20;
    async function load(){
      const token = localStorage.getItem('nav_token');
      const q = document.getElementById('q').value || '';
      const res = await fetch(`/api/admin/orders?q=${encodeURIComponent(q)}&page=${page}&limit=${limit}`, { headers: { Authorization: 'Bearer '+token }});
      if (res.status === 401 || res.status === 403) return document.getElementById('orders').innerText = 'Unauthorized';
      const j = await res.json();
      const el = document.getElementById('orders');
      if (!j.orders.length) return el.innerHTML = '<div class="alert alert-info">No orders</div>';
      el.innerHTML = '<div class="list-group">' + j.orders.map(o => `
        <a class="list-group-item list-group-item-action" href="/admin_order_detail.html?id=${o.id}">
          <div class="fw-bold">${o.id} — ${o.status} — ${o.client?.email || 'unknown'}</div>
          <div>${(o.totalCents/100).toFixed(2)} • ${o.media.length} media • ${new Date(o.createdAt).toLocaleString()}</div>
        </a>`).join('') + '</div>';

      // pager
      const pager = document.getElementById('pager');
      pager.innerHTML = '';
      const total = j.total || 0;
      const pages = Math.max(1, Math.ceil(total / limit));
      for(let p=1;p<=pages && p<=10;p++){
        const li = document.createElement('li'); li.className = 'page-item'+(p===page?' active':'');
        const a = document.createElement('a'); a.className='page-link'; a.href='#'; a.innerText=p; a.onclick=(ev)=>{ ev.preventDefault(); page=p; load(); };
        li.appendChild(a); pager.appendChild(li);
      }
    }
    document.getElementById('searchBtn').addEventListener('click', ()=>{ page = 1; load(); });
    load();
  </script>

  <script src="../assets/vendor/bootstrap/bootstrap.bundle.min.js"></script>
  <script src="../assets/js/script.js"></script>
</body>
</html>
